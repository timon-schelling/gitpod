---
- name: Create a Google Cloud Platform (GCP) virtual machine (VM)
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    name_prefix: gitpod-k3s
    nodes_count: 3
    gcp_project: clu-self-hosted-playground
    gcp_cred_file: /tmp/service-account.json
    # https://cloud.google.com/compute/docs/regions-zones
    gcp_region: europe-west3
    gcp_zone: europe-west3-a
    # available types: gcloud compute machine-types list --zones=europe-west3-a
    gcp_machine_type: c2-standard-4

    gcp_dns_project: dns-for-playgrounds
    gcp_domain_zone_name: gitpod-self-hosted-com
    gcp_domain_zone_dnsname: gitpod-self-hosted.com.
    gitpod_domain: clu-gcp-k3s-2.gitpod-self-hosted.com

  # https://docs.ansible.com/ansible/latest/collections/google/cloud/gcp_compute_instance_module.html
  tasks:

    - name: create instance
      google.cloud.gcp_compute_instance:
        name: "{{ name_prefix }}--node-{{ item }}"
        machine_type: "{{ gcp_machine_type }}"
        disks:
        - auto_delete: 'true'
          boot: 'true'
          initialize_params:
            disk_size_gb: 256
            source_image: projects/ubuntu-os-cloud/global/images/family/ubuntu-2004-lts
        network_interfaces:
        - access_configs:
          - name: External NAT
            type: ONE_TO_ONE_NAT
        labels:
          gitpod-node: "{{ 'main' if ansible_loop.first else 'worker' }}"
          gitpod-total-nodes: "{{ ansible_loop.length }}"
        zone: "{{ gcp_zone }}"
        project: "{{ gcp_project }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_cred_file }}"
        state: present
      loop: "{{ range(0, nodes_count) | list }}"
      loop_control:
        extended: yes
      register: gcpvm

    # - debug:
    #     var: gcpvm.results
    - debug:
        msg: "Cluster IP: {{ gcpvm.results[0].networkInterfaces[0].networkIP }}"

    - name: create resource record sets
      google.cloud.gcp_dns_resource_record_set:
        name: "{{ item }}"
        managed_zone:
          name: "{{ gcp_domain_zone_name }}"
          dnsName: "{{ gcp_domain_zone_dnsname }}"
        type: A
        ttl: 300
        target:
        - "{{ gcpvm.results[0].networkInterfaces[0].networkIP }}"
        project: "{{ gcp_dns_project }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_cred_file }}"
        state: present
      with_items:
      - "{{ gitpod_domain }}."
      - "*.{{ gitpod_domain }}."
      - "*.ws.{{ gitpod_domain }}."

    - name: create http/https firewall rule
      google.cloud.gcp_compute_firewall:
        name: "allow-http-https"
        allowed:
        - ip_protocol: tcp
          ports: ["80","443"]
        direction: INGRESS
        source_ranges: "0.0.0.0/0"
        project: "{{ gcp_project }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_cred_file }}"
        state: present

    - name: create k3s firewall rule
      google.cloud.gcp_compute_firewall:
        name: "allow-k3s"
        allowed:
        - ip_protocol: tcp
          ports: ["6443"]
        direction: INGRESS
        source_ranges: "0.0.0.0/0"
        project: "{{ gcp_project }}"
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_cred_file }}"
        state: present
